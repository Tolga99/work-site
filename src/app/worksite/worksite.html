<ion-content style="justify-content: start;">
<!-- <ion-header>
  <ion-toolbar>
    <ion-button (click)="GoBack()">
      <ion-icon name="arrow-left"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header> -->

<ion-header>
  <ion-toolbar>
    <ion-tabs>
      <ion-tab-bar slot="top">
        <dx-button icon="fas fa-arrow-left" (click)="GoBack()" style="background-color: orange;">
        </dx-button>
        <ion-tab-button (click)="SetTabView('general')">
          <ion-icon name="information-circle"></ion-icon>
          <ion-label>{{'general' | translate}}</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('achats')">
          <ion-icon name="copy"></ion-icon>
          <ion-label>{{'achats' | translate}}</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('travail')">
          <ion-icon name="hammer"></ion-icon>
          <ion-label>{{'work' | translate}}</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('images')">
          <ion-icon name="images"></ion-icon>
          <ion-label>{{'pictures' | translate}}</ion-label>
        </ion-tab-button>

      </ion-tab-bar>
    </ion-tabs>
  </ion-toolbar>
</ion-header>

<div style="overflow-y: auto; justify-content: start; background-color: white; overflow-x: hidden;">
  <form [formGroup]="formChantier" (ngSubmit)="SaveChantier()">
    <div [hidden]="(TabView !== 'general')" class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
      <div class="card-header tabHeader">
        {{'infos' | translate}}
      </div>
      <ion-item class="form-group" required="required">
        <ion-label position="stacked">{{'nameWorksite' | translate}}</ion-label>
        <ion-input type="text" id="name" name="name" formControlName="chantierName" placeholder="..."
          required="required" maxlength="50"></ion-input>
      </ion-item>

      <ion-item class="form-group" required="required">
        <ion-label position="stacked">{{'worksiteAddress' | translate}}</ion-label>
        <ion-input type="text" id="address" name="address" formControlName="address" placeholder="..." maxlength="50"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">{{'description' | translate}}</ion-label>
        <ion-textarea id="description" name="description" formControlName="description" placeholder="..." maxlength="50"
          style="height:100px;"></ion-textarea>
      </ion-item>
      <hr>
    </div>
    <div [hidden]="(TabView !== 'achats')">
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="card-header tabHeader">
          {{'invoices' | translate}}
        </div>


        <mat-form-field appearance="standard">
          <mat-label>{{'search' | translate}}</mat-label>
          <input matInput (keyup)="applyFilterFacture($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceFacture" matSort (matSortChange)="announceSortChangeFacture($event)">
            <ng-container matColumnDef="factureName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> {{'invoiceName' | translate}}
              </th>
              <td mat-cell *matCellDef="let row"> {{row.factureName}} </td>
            </ng-container>

            <ng-container matColumnDef="totalPrice">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> {{'total' | translate}} </th>
              <td mat-cell *matCellDef="let row"> {{row.totalPrice}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> {{'date' | translate}} </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>

            <ng-container matColumnDef="IsPaid">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by paid"> {{'state' | translate}} </th>
              <td mat-cell *matCellDef="let row" style="color: red;"> {{IsInvoicePaid(row)}} </td>
            </ng-container>


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button type="button" mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>toc</mat-icon>

                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item type="button" (click)="openInvoice(row)">
                    <mat-icon>edit</mat-icon>
                    <span>{{'editInv' | translate}}</span>
                  </button>
                  <button mat-menu-item type="button" (click)="GeneratePDFInvoice(row)">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>{{'genPDF' | translate}}</span>
                  </button>
                  <button mat-menu-item type="button" (click)="deleteInvoice(row)">
                    <mat-icon>delete</mat-icon>
                    <span>{{'delete' | translate}}</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsInv"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsInv;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">{{'noData' | translate}} "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons
            aria-label="Select page of dataSourceFacture"></mat-paginator>
        </div>
        <div class="card-footer text-muted" style="text-align:center; display: flex;
        justify-content: space-evenly;
        align-items: center;">
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" (click)="scanInvoice()" icon="fas fa-paste" [text]="'scanInvoice' | translate"></dx-button>
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" (click)="createInvoice()" icon="fas fa-file-invoice" [text]="'createInvoice' | translate"></dx-button>
        </div>
      </div>

      <hr>
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="card-header tabHeader">
          {{'estimate' | translate}}
        </div>

        <mat-form-field appearance="standard">
          <mat-label>{{'search' | translate}}</mat-label>
          <input matInput (keyup)="applyFilterDevis($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceDevis" matSort (matSortChange)="announceSortChangeDevis($event)">
            <ng-container matColumnDef="factureName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> {{'estimateName' | translate}}
              </th>
              <td mat-cell *matCellDef="let row"> {{row.factureName}} </td>
            </ng-container>

            <ng-container matColumnDef="totalPrice">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> {{'total' | translate}} </th>
              <td mat-cell *matCellDef="let row"> {{row.totalPrice}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> {{'date' | translate}} </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>

            <!-- <ng-container matColumnDef="IsPaid">
          <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by paid"> Etat </th>
          <td mat-cell *matCellDef="let row" style="color: red;"> {{IsInvoicePaid(row)}} </td>
        </ng-container> -->


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button type="button" mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>toc</mat-icon>

                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item type="button" (click)="openDevis(row)">
                    <mat-icon>edit</mat-icon>
                    <span>{{'editEstimate' | translate}}</span>
                  </button>
                  <button mat-menu-item (click)="TransformToInvoice(row)" type="button">
                    <mat-icon>edit</mat-icon>
                    <span>{{'transformToInv' | translate}}</span>
                  </button>
                  <button mat-menu-item type="button" (click)="GeneratePDFInvoice(row)">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>{{'genPDF' | translate}}</span>
                  </button>
                  <button mat-menu-item type="button" (click)="deleteDevis(row)">
                    <mat-icon>delete</mat-icon>
                    <span>{{'delete' | translate}}</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsDev"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsDev;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">{{'noData' | translate}} "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of dataSourceDevis">
          </mat-paginator>
        </div>
        <div class="card-footer text-muted" style="text-align:center; display: flex;
        justify-content: space-evenly;
        align-items: center;">
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" (click)="scanDevis()" icon="fas fa-paste" [text]="'scanEstimate' | translate"></dx-button>
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" (click)="createDevis()" icon="fas fa-file-invoice-dollar" [text]="'createEstimate' | translate"></dx-button>
        </div>
      </div>
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="card-header tabHeader">
          {{'receivedMoney' | translate}}
        </div>
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar" id="managerTable">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th *ngFor="let head of headElementsRecv" scope="col">{{head}} </th>
              </tr>
            </thead>
            <tbody *ngFor="let inv of chantier?.factures">
              <tr mdbTableCol *ngFor="let p of inv.receivedMoney">
                <!-- <th scope="row">{{h.id}}</th> -->
                <td>{{inv.factureName}}</td>
                <td>{{p.price}}</td>
                <td>{{inv.totalPrice}}</td>
                <td>{{inv?.totalPrice - GetAllReceivedMoney(inv) | number : '1.2'}}</td>
                <td>{{p.date}}</td>
                <td (click)="$event.stopPropagation()">
                  <button mat-icon-button [matMenuTriggerFor]="menu" type="button">
                    <mat-icon>toc</mat-icon>

                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item type="button">
                      <mat-icon>edit</mat-icon>
                      <span>{{'edit' | translate}}</span>
                    </button>
                    <button mat-menu-item type="button" (click)="DeleteReceive(inv,p)">
                      <mat-icon>delete</mat-icon>
                      <span>{{'delete' | translate}}</span>
                    </button>
                  </mat-menu>
                </td> <!-- </tr> -->
            </tbody>
          </table>
        </div>
        <div class="card-footer text-muted">
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" (click)="AddPayment()" 
          icon="fas fa-cart-plus" [text]="'addPayment' | translate"></dx-button>
        </div>
      </div>
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th>{{'tickets' | translate}}</th>
              </tr>
            </thead>
            <tbody>
              <tr mdbTableCol *ngFor='let url of imagesT'>
                <td><img src="{{url}}" alt="" height=100 width=100 /></td>
                <td> <dx-button type="button" class="btn btn-danger" style="background-color:orange;" (click)="DeleteImage(url)" icon="fas fa-trash"></dx-button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer text-muted">
          <input id="imgChantier" type="file" class="form-control" multiple="" (change)="onFileChangeTicket($event)">
        </div>
      </div>

    </div>

    <div [hidden]="(TabView !== 'travail')">
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="card-header tabHeader">
          {{'hoursWorked' | translate}}
        </div>


        <mat-form-field appearance="standard">
          <mat-label>{{'search' | translate}}</mat-label>
          <input matInput (keyup)="applyFilterHeure($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceHeure" matSort (matSortChange)="announceSortChangeHeure($event)">
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> {{'description' | translate}}
              </th>
              <td mat-cell *matCellDef="let row"> {{row.description}} </td>
            </ng-container>

            <ng-container matColumnDef="workTime">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> {{'hourWorked' | translate}}
              </th>
              <td mat-cell *matCellDef="let row"> {{row.workTime}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> {{'date' | translate}} </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button mat-icon-button [matMenuTriggerFor]="menu" type="button">
                  <mat-icon>toc</mat-icon>

                </button>
                <mat-menu #menu="matMenu" (click)="$event.stopPropagation()">
                  <button mat-menu-item type="button" (click)="openHour(row)">
                    <mat-icon>edit</mat-icon>
                    <span>{{'edit' | translate}}</span>
                  </button>
                  <button mat-menu-item (click)="deleteHour(row)" type="button">
                    <mat-icon>delete</mat-icon>
                    <span>{{'delete' | translate}}</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsHour"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsHour;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">{{'noData' | translate}} "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of dataSourceHeure">
          </mat-paginator>
        </div>

        <div class="card-footer">
          {{'totalHours' | translate}} {{totalHours}}
        </div>
        <div class="card-footer text-muted">
          <dx-button type="button" class="btn btn-secondary" style="background-color:orange;" 
          (click)="AddHour()" icon="fas fa-clock" [text]="'addWork' | translate" ></dx-button>
        </div>
      </div>
    </div>

    <div [hidden]="(TabView !== 'images')">
      <div class="jumbotron text-center" style="margin-bottom: 0; padding-bottom: 1px; padding-top: 1px;">
        <div class="card-header tabHeader">
          {{'worksitePictures' | translate}}
        </div>
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th>{{'pictures' | translate}}</th>
              </tr>
            </thead>
            <tbody>
              <tr mdbTableCol *ngFor='let url of imagesC'>
                <!-- <th scope="row">{{el.id}}</th> -->
                <td><img src="{{url}}" alt="" height=100 width=100 /></td>
                <td> <dx-button type="button" class="btn btn-danger" style="background-color:orange;" 
                  (click)="DeleteImageChantier(url)" icon="fas fa-trash"></dx-button></td>
              </tr>
            </tbody>
          </table>

        </div>
        <div class="card-footer text-muted">
          <input id="imgChantier" type="file" class="form-control" multiple="" (change)="onFileChangeChantier($event)">
        </div>
      </div>
    </div>
  <div class="card-footer text-muted">
    <div style="padding: 10px; margin: 5px;">
    <dx-button [useSubmitBehavior]="true" type="submit" class="btn btn-success" style="width:88%;" [text]="'updateWorksite' | translate"></dx-button>
    <dx-button type="submit" class="btn btn-danger" (click)="FinishChantier()" style="width: 88%;" [text]="'finishWorksite' | translate"></dx-button>
    </div>
  </div>
  </form>
</div>
</ion-content>