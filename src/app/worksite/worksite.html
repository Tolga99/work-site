<ion-header>
  <ion-toolbar>
    <ion-button (click)="GoBack()">
      <ion-icon name="arrow-back"></ion-icon>
      <ion-label>Retour</ion-label>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-header>
  <ion-toolbar>
    <ion-tabs>
      <ion-tab-bar slot="top">
        <ion-tab-button (click)="SetTabView('general')">
          <ion-icon name="information-circle"></ion-icon>
          <ion-label>Général</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('achats')">
          <ion-icon name="copy"></ion-icon>
          <ion-label>Achats</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('travail')">
          <ion-icon name="hammer"></ion-icon>
          <ion-label>Travail</ion-label>
        </ion-tab-button>

        <ion-tab-button (click)="SetTabView('images')">
          <ion-icon name="images"></ion-icon>
          <ion-label>Images</ion-label>
        </ion-tab-button>

      </ion-tab-bar>
    </ion-tabs>
  </ion-toolbar>
</ion-header>


<div style="overflow-y: auto;">
  <form [formGroup]="formChantier" (ngSubmit)="SaveChantier()">
    <div [hidden]="(TabView !== 'general')" class="jumbotron text-center">
      <div class="card-header">
        Informations
      </div>
      <ion-item class="form-group" required="required">
        <ion-label position="floating">Nom chantier</ion-label>
        <ion-input type="text" id="name" name="name" formControlName="chantierName" placeholder="..."
          required="required"></ion-input>
      </ion-item>

      <ion-item class="form-group" required="required">
        <ion-label position="floating">Adresse du chantier</ion-label>
        <ion-input type="text" id="address" name="address" formControlName="address" placeholder="..."></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Description</ion-label>
        <ion-textarea id="description" name="description" formControlName="description" placeholder="..."
          style="height:100px;"></ion-textarea>
      </ion-item>
      <hr>
    </div>
    <div [hidden]="(TabView !== 'achats')">
      <div class="jumbotron text-center">
        <div class="card-header">
          Factures
        </div>


        <mat-form-field appearance="standard">
          <mat-label>Recherche</mat-label>
          <input matInput (keyup)="applyFilterFacture($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceFacture" matSort (matSortChange)="announceSortChangeFacture($event)">
            <ng-container matColumnDef="factureName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> Nom facture
              </th>
              <td mat-cell *matCellDef="let row"> {{row.factureName}} </td>
            </ng-container>

            <ng-container matColumnDef="totalPrice">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> Total </th>
              <td mat-cell *matCellDef="let row"> {{row.totalPrice}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> Date </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>

            <ng-container matColumnDef="IsPaid">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by paid"> Etat </th>
              <td mat-cell *matCellDef="let row" style="color: red;"> {{IsInvoicePaid(row)}} </td>
            </ng-container>


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button type="button" mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_horiz</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item type="button" (click)="openInvoice(row)">
                    <mat-icon>edit</mat-icon>
                    <span>Modifier facture</span>
                  </button>
                  <button mat-menu-item type="button" (click)="GeneratePDFInvoice(row)">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>Génerer son PDF</span>
                  </button>
                  <button mat-menu-item type="button" (click)="deleteInvoice(row)">
                    <mat-icon>delete</mat-icon>
                    <span>Supprimer</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsInv"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsInv;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">No data matching the Recherche "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons
            aria-label="Select page of dataSourceFacture"></mat-paginator>
        </div>
      </div>

      <div class="card-footer text-muted">
        <button type="button" class="btn btn-secondary" (click)="scanInvoice()">Scanner facture</button>
        <button type="button" class="btn btn-secondary" (click)="createInvoice()">Créer facture</button>
      </div>

      <hr>
      <div class="jumbotron text-center">
        <div class="card-header">
          Devis
        </div>

        <mat-form-field appearance="standard">
          <mat-label>Recherche</mat-label>
          <input matInput (keyup)="applyFilterDevis($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceDevis" matSort (matSortChange)="announceSortChangeDevis($event)">
            <ng-container matColumnDef="factureName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> Nom devis
              </th>
              <td mat-cell *matCellDef="let row"> {{row.factureName}} </td>
            </ng-container>

            <ng-container matColumnDef="totalPrice">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> Total </th>
              <td mat-cell *matCellDef="let row"> {{row.totalPrice}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> Date </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>

            <!-- <ng-container matColumnDef="IsPaid">
          <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by paid"> Etat </th>
          <td mat-cell *matCellDef="let row" style="color: red;"> {{IsInvoicePaid(row)}} </td>
        </ng-container> -->


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button type="button" mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_horiz</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item type="button" (click)="openDevis(row)">
                    <mat-icon>edit</mat-icon>
                    <span>Modifier devis</span>
                  </button>
                  <button mat-menu-item (click)="TransformToInvoice(row)" type="button">
                    <mat-icon>edit</mat-icon>
                    <span>Transformer en facture</span>
                  </button>
                  <button mat-menu-item type="button" (click)="GeneratePDFInvoice(row)">
                    <mat-icon>picture_as_pdf</mat-icon>
                    <span>Génerer son PDF</span>
                  </button>
                  <button mat-menu-item type="button" (click)="deleteDevis(row)">
                    <mat-icon>delete</mat-icon>
                    <span>Supprimer</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsDev"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsDev;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">No data matching the Recherche "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of dataSourceDevis">
          </mat-paginator>
        </div>

        <div class="card-footer text-muted">
          <button type="button" class="btn btn-secondary" (click)="scanDevis()">Scanner devis</button>
          <button type="button" class="btn btn-secondary" (click)="createDevis()">Créer devis</button>
        </div>
      </div>
      <div class="jumbotron text-center">
        <div class="card-header">
          Argent reçu
        </div>
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar" id="managerTable">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th *ngFor="let head of headElementsRecv" scope="col">{{head}} </th>
              </tr>
            </thead>
            <tbody *ngFor="let inv of chantier?.factures">
              <tr mdbTableCol *ngFor="let p of inv.receivedMoney">
                <!-- <th scope="row">{{h.id}}</th> -->
                <td>{{inv.factureName}}</td>
                <td>{{p.price}}</td>
                <td>{{inv.totalPrice}}</td>
                <td>{{inv?.totalPrice - GetAllReceivedMoney(inv) | number : '1.2'}}</td>
                <td>{{p.date}}</td>
                <td (click)="$event.stopPropagation()">
                  <button mat-icon-button [matMenuTriggerFor]="menu" type="button">
                    <mat-icon>more_horiz</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item type="button">
                      <mat-icon>edit</mat-icon>
                      <span>Modifier</span>
                    </button>
                    <button mat-menu-item type="button" (click)="DeleteReceive(inv,p)">
                      <mat-icon>delete</mat-icon>
                      <span>Supprimer</span>
                    </button>
                  </mat-menu>
                </td> <!-- </tr> -->
            </tbody>
          </table>
        </div>
        <div class="card-footer text-muted">
          <button type="button" class="btn btn-secondary" (click)="AddPayment()">Ajouter paiement</button>
        </div>
      </div>
    </div>

    <div [hidden]="(TabView !== 'travail')">
      <div class="jumbotron text-center">
        <div class="card-header">
          Heures préstées
        </div>


        <mat-form-field appearance="standard">
          <mat-label>Recherche</mat-label>
          <input matInput (keyup)="applyFilterHeure($event)" placeholder="Ex. Mia" #input>
        </mat-form-field>

        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="dataSourceHeure" matSort (matSortChange)="announceSortChangeHeure($event)">
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by name"> Description
              </th>
              <td mat-cell *matCellDef="let row"> {{row.description}} </td>
            </ng-container>

            <ng-container matColumnDef="workTime">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by total"> Heure travail
              </th>
              <td mat-cell *matCellDef="let row"> {{row.workTime}} </td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by date"> Date </th>
              <td mat-cell *matCellDef="let row"> {{row.date}} </td>
            </ng-container>


            <ng-container matColumnDef="...">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> ... </th>
              <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()">
                <button mat-icon-button [matMenuTriggerFor]="menu" type="button">
                  <mat-icon>more_horiz</mat-icon>
                </button>
                <mat-menu #menu="matMenu" (click)="$event.stopPropagation()">
                  <button mat-menu-item type="button" (click)="openHour(row)">
                    <mat-icon>edit</mat-icon>
                    <span>Modifier</span>
                  </button>
                  <button mat-menu-item (click)="deleteHour(row)" type="button">
                    <mat-icon>delete</mat-icon>
                    <span>Supprimer</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>


            <tr mat-header-row *matHeaderRowDef="headElementsHour"></tr>
            <tr mat-row *matRowDef="let row; columns: headElementsHour;"></tr>

            <!-- Row shown when there is no matching data. -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">No data matching the Recherche "{{input.value}}"</td>
            </tr>

          </table>

          <mat-paginator mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of dataSourceHeure">
          </mat-paginator>
        </div>

        <div class="card-footer">
          Total des heures : {{totalHours}}
        </div>
        <div class="card-footer text-muted">
          <button type="button" class="btn btn-secondary" (click)="AddHour()">Ajouter prestation</button>
        </div>
      </div>
    </div>

    <div [hidden]="(TabView !== 'images')">
      <div class="jumbotron text-center">
        <div class="card-header">
          Images du chantier
        </div>
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th>Image</th>
              </tr>
            </thead>
            <tbody>
              <tr mdbTableCol *ngFor='let url of imagesC'>
                <!-- <th scope="row">{{el.id}}</th> -->
                <td><img src="{{url}}" alt="" height=100 width=100 /></td>
                <td> <button type="button" class="btn btn-danger"> <i class="far fa-trash-alt"></i></button></td>
              </tr>
            </tbody>
          </table>

        </div>
        <div class="card-footer text-muted">
          <input id="imgChantier" type="file" class="form-control" multiple="" (change)="onFileChangeChantier($event)">
        </div>
      </div>

      <div class="jumbotron text-center">
        <div class="col-auto table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th>Image</th>
              </tr>
            </thead>
            <tbody>
              <tr mdbTableCol *ngFor='let url of imagesT'>
                <!-- <th scope="row">{{el.id}}</th> -->
                <td>test</td>
                <td>test</td>
                <td><img src="{{url}}" alt="" height=100 width=100 /></td>
                <td> <button type="button" class="btn btn-danger"> <i class="far fa-trash-alt"></i></button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer text-muted">
          <input id="imgChantier" type="file" class="form-control" multiple="" (change)="onFileChangeTicket($event)">
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-success">Actualiser chantier</button>
    <button type="submit" class="btn btn-danger" (click)="FinishChantier()">Terminer chantier</button>

  </form>
</div>